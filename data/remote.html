<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Remote Control</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff;
    }
    h1 {
      text-align: center;
      margin: 20px 0 10px;
    }
    /* Tab-style navigation bar */
    .tabBar {
      text-align: center;
      margin-bottom: 20px;
    }
    .tabBar a {
      text-decoration: none;
      color: black;
      background: #ccc;
      margin: 0 5px;
      padding: 8px 16px;
      display: inline-block;
      border-radius: 4px;
      font-weight: bold;
    }
    .tabBar a:hover {
      background: #bbb;
    }
    .tabBar a.active {
      background: #aaa;
    }
    /* Center the SVG on the page */
    .svgContainer {
      text-align: center;
      margin-bottom: 40px;
    }
    svg {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- Page Title -->
  <h1>ShackMate - Tuner (MFJ-993B)</h1>

  <!-- Navigation Tabs -->
  <div class="tabBar">
    <a href="/">Dashboard</a>
    <a href="/remote" class="active">Remote</a>
  </div>  <!-- SVG Remote Control -->
  <div class="svgContainer">
    <svg id="tuner-svg" width="600" height="400" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
      <!-- Background -->
      <rect x="0" y="0" width="600" height="400" fill="black" />

      <!-- Title -->
      <text x="300" y="40" fill="white" font-size="20" text-anchor="middle">
        MFJ IntelliTunerâ„¢ REMOTE CONTROL
      </text>
      
      <!-- LED indicators repositioned inline with bottom row -->
      <!-- TUNING LED -->
      <g id="led-tuning">
        <!-- Placed left of bottom row -->
        <circle cx="140" cy="195" r="5" fill="red" />
        <text x="150" y="200" fill="white" font-size="14">TUNING</text>
      </g>
      <!-- SWR LED -->
      <g id="led-swr">
        <circle cx="140" cy="225" r="5" fill="green" />
        <text x="150" y="230" fill="white" font-size="14">SWR</text>
      </g>
      
      <!-- Top Row (y=100) -->
      <!-- ANT button (latching) -->
      <g id="button-ant" cursor="pointer">
        <!-- Original x=80 + 75 = 155 -->
        <rect x="155" y="100" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="180" y="130" fill="black" font-size="14" text-anchor="middle">%ANT_STATE%</text>
      </g>
      <!-- C-UP button (momentary) -->
      <g id="button-cup" cursor="pointer">
        <!-- 160 + 75 = 235 -->
        <rect x="235" y="100" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="260" y="130" fill="black" font-size="14" text-anchor="middle">C-UP</text>
      </g>
      <!-- L-UP button (momentary) -->
      <g id="button-lup" cursor="pointer">
        <!-- 240 + 75 = 315 -->
        <rect x="315" y="100" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="340" y="130" fill="black" font-size="14" text-anchor="middle">L-UP</text>
      </g>
      <!-- AUTO button (latching) -->
      <g id="button-auto" cursor="pointer">
        <!-- 320 + 75 = 395 -->
        <rect x="395" y="100" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="420" y="130" fill="black" font-size="14" text-anchor="middle">%AUTO_STATE%</text>
      </g>

      <!-- Bottom Row (y=180) -->
      <!-- C-DN button (momentary) -->
      <g id="button-cdn" cursor="pointer">
        <!-- 160 + 35 = 195 -->
        <rect x="235" y="180" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="260" y="210" fill="black" font-size="14" text-anchor="middle">C-DN</text>
      </g>
      <!-- L-DN button (momentary) -->
      <g id="button-ldn" cursor="pointer">
        <!-- 240 + 35 = 275 -->
        <rect x="315" y="180" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="340" y="210" fill="black" font-size="14" text-anchor="middle">L-DN</text>
      </g>
      <!-- TUNE button (momentary) -->
      <g id="button-tune" cursor="pointer">
        <!-- 320 + 35 = 355 -->
        <rect x="395" y="180" width="50" height="50" fill="#eee" stroke="#333" stroke-width="2" rx="4" ry="4"/>
        <text x="420" y="210" fill="black" font-size="14" text-anchor="middle">TUNE</text>
      </g>
    </svg>
  </div>

  <!-- Inline JavaScript to handle button interactions with WebSocket -->
  <script>
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 3000; // 3 seconds

    // Latched buttons: ANT and AUTO
    const latchedButtons = {
      "button-ant": { latched: false, labelOff: "%ANT_STATE%", labelOn: "ANT 2" },
      "button-auto": { latched: false, labelOff: "%AUTO_STATE%", labelOn: "AUTO" }
    };

    // For momentary buttons
    const momentaryIDs = [ "button-cup", "button-lup", "button-cdn", "button-ldn", "button-tune" ];

    function connectWebSocket() {
      try {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.hostname}:%WEBSOCKET_PORT%/ws`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
          console.log('Remote WebSocket connected');
          reconnectAttempts = 0;
        };
        
        ws.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'state_update') {
              updateButtonStates(data);
            }
          } catch (e) {
            console.log('WebSocket message:', event.data);
          }
        };
        
        ws.onclose = function() {
          console.log('Remote WebSocket disconnected');
          ws = null;
          // Attempt to reconnect
          if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            setTimeout(connectWebSocket, reconnectDelay);
          }
        };
        
        ws.onerror = function(error) {
          console.error('Remote WebSocket error:', error);
        };
      } catch (e) {
        console.error('Error creating WebSocket connection:', e);
      }
    }

    function sendWebSocketMessage(message) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(message);
      } else {
        console.warn('WebSocket not connected, falling back to HTTP');
        // Fallback to HTTP for critical operations
        if (message.startsWith('latch:')) {
          const parts = message.split(':');
          const button = parts[1];
          const state = parts[2];
          fetch("/updateLatch?button=" + button + "&state=" + state);
        }
      }
    }

    function updateButtonStates(data) {
      // Update latched button states from server
      if (data.ant_state !== undefined) {
        const antLatched = data.ant_state === "ANT 2";
        latchedButtons["button-ant"].latched = antLatched;
        updateLatchedButtonDisplay("button-ant");
      }
      if (data.auto_state !== undefined) {
        const autoLatched = data.auto_state === "AUTO";
        latchedButtons["button-auto"].latched = autoLatched;
        updateLatchedButtonDisplay("button-auto");
      }
    }

    // Function to update latched button appearance and send state update to server
    function updateLatchedButton(id) {
      const info = latchedButtons[id];
      updateLatchedButtonDisplay(id);
      
      // Send new state via WebSocket
      const message = `latch:${id}:${info.latched}`;
      sendWebSocketMessage(message);
    }

    function updateLatchedButtonDisplay(id) {
      const info = latchedButtons[id];
      const group = document.getElementById(id);
      if (!group) return;
      const rect = group.querySelector("rect");
      const textEl = group.querySelector("text");
      if (info.latched) {
        rect.setAttribute("fill", "#bbb");
        textEl.textContent = info.labelOn;
      } else {
        rect.setAttribute("fill", "#eee");
        textEl.textContent = info.labelOff;
      }
    }

    function sendMomentaryCommand(id, state) {
      const message = `momentary:${id}:${state}`;
      sendWebSocketMessage(message);
    }

    document.addEventListener("DOMContentLoaded", function() {
      // Initialize WebSocket connection
      connectWebSocket();

      // Attach event listeners for latched buttons
      for (let id in latchedButtons) {
        const group = document.getElementById(id);
        if (!group) continue;
        const rect = group.querySelector("rect");

        group.addEventListener("mousedown", function() {
          rect.setAttribute("fill", "#bbb");
        });
        group.addEventListener("mouseup", function() {
          latchedButtons[id].latched = !latchedButtons[id].latched;
          updateLatchedButton(id);
        });
        group.addEventListener("mouseleave", function() {
          if (!latchedButtons[id].latched) {
            rect.setAttribute("fill", "#eee");
          }
        });
        group.addEventListener("touchstart", function(e) {
          e.preventDefault();
          rect.setAttribute("fill", "#bbb");
        }, { passive: false });
        group.addEventListener("touchend", function(e) {
          e.preventDefault();
          latchedButtons[id].latched = !latchedButtons[id].latched;
          updateLatchedButton(id);
        }, { passive: false });
      }

      // Attach event listeners for momentary buttons
      momentaryIDs.forEach(function(id) {
        const group = document.getElementById(id);
        if (!group) return;
        const rect = group.querySelector("rect");
        if (!rect) return;
        
        group.addEventListener("mousedown", function() {
          rect.setAttribute("fill", "#bbb");
          sendMomentaryCommand(id, "on");
        });
        group.addEventListener("mouseup", function() {
          rect.setAttribute("fill", "#eee");
          sendMomentaryCommand(id, "off");
        });
        group.addEventListener("mouseleave", function() {
          rect.setAttribute("fill", "#eee");
          sendMomentaryCommand(id, "off");
        });
        group.addEventListener("touchstart", function(e) {
          e.preventDefault();
          rect.setAttribute("fill", "#bbb");
          sendMomentaryCommand(id, "on");
        }, { passive: false });
        group.addEventListener("touchend", function(e) {
          e.preventDefault();
          rect.setAttribute("fill", "#eee");
          sendMomentaryCommand(id, "off");
        }, { passive: false });
      });
    });

    // Cleanup WebSocket when page unloads
    window.addEventListener('beforeunload', function() {
      if (ws) {
        ws.close();
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>%PROJECT_NAME% - Dashboard</title>
    <style>
      .chain-link-btn.active {
        background: #eaffea !important;
        box-shadow: 0 0 0 2px #43a047, 1px 1px 3px #bbb;
        border-radius: 10px;
      }
      .chain-highlight {
        border-color: #43a047 !important;
        box-shadow: 0 0 0 2px #43a047, 1px 1px 3px #bbb !important;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        /* fallback for old browsers */
        background-color: #764ba2;
      }
      .dashboard-container {
        max-width: 1200px;
        margin: 40px auto 40px auto;
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        padding: 36px 32px 32px 32px;
        min-height: 80vh;
      }
      .header {
        font-size: 2.5em;
        margin-bottom: 0.1em;
        color: #22334d;
        text-align: center;
        text-shadow: 0 2px 8px rgba(0,0,0,0.08);
        font-weight: 500;
      }
      .version-label {
        text-align: center;
        color: #7b868c;
        font-size: 1.35em;
        margin-top: 0.1em;
        margin-bottom: 1.2em;
        font-weight: 400;
        letter-spacing: 0.01em;
        text-shadow: none;
      }
      .subtitle {
        text-align: center;
        color: #7b868c;
        font-size: 2em;
        margin-top: 0.2em;
        margin-bottom: 1.5em;
        font-weight: 400;
        letter-spacing: 0.01em;
        text-shadow: 0 2px 8px rgba(0,0,0,0.06);
      }
      /* Tuner Control Card Styles */
      .tuner-indicators-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0 8px 0;
        padding: 0 8px;
      }
      .tuner-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tuner-indicator.left {
        justify-content: flex-start;
      }
      .tuner-indicator.right {
        justify-content: flex-end;
      }
      .indicator-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 2px;
        border: 2px solid #222;
      }
      .indicator-dot.tuning {
        background: #e53935;
        border-color: #b71c1c;
      }
      .indicator-dot.swr {
        background: #388e3c;
        border-color: #1b5e20;
      }
      .indicator-label {
        color: #111;
        font-size: 0.98em;
        font-weight: 600;
        letter-spacing: 1px;
        text-shadow: none;
      }
      .tuner-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr auto 1fr;
        gap: 18px 32px;
        justify-items: center;
        align-items: center;
        margin: 18px 0 8px 0;
        position: relative;
      }
      .tuner-grid button {
        min-width: 60px;
        min-height: 60px;
        font-size: 1.18em;
        border-radius: 8px;
        border: 2px solid #888;
        background: #f4f4f4;
        box-shadow: 1px 1px 3px #bbb;
        transition: background 0.2s, box-shadow 0.2s;
        grid-column: auto;
        grid-row: auto;
      }
      .tuner-grid .tune-center {
        grid-column: 1 / span 2;
        grid-row: 3;
        justify-self: center;
        align-self: center;
      }
      .tuner-grid button:active {
        background: #e0e0e0;
        box-shadow: none;
      }
      /* When both linked buttons are pressed together, show a stronger highlight */
      .momentary-btn.active {
        background: #c8f7c5 !important;
        border-color: #43a047 !important;
        box-shadow: 0 0 0 2px #43a047, 1px 1px 3px #bbb !important;
      }
      .latch-btn.active {
        background: #cce5ff;
        border-color: #3399ff;
      }
      .momentary-btn:active {
        background: #ffe5cc;
        border-color: #ff9933;
      }
      
      /* Removed duplicate .header rule that set color: #fff; and text-shadow */

      .subtitle {
        text-align: center;
        color: #fff;
        font-size: 1.1em;
        margin-bottom: 0.8em;
        opacity: 0.9;
      }
      
      .tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 10px;
      }
      
      .tabs a {
        padding: 12px 24px;
        text-decoration: none;
        color: #fff;
        background-color: rgba(255,255,255,0.2);
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        border: 1px solid rgba(255,255,255,0.3);
      }
      
      .tabs a:hover {
        background-color: rgba(255,255,255,0.3);
        transform: translateY(-2px);
      }
      
      .tabs a.active {
        background-color: rgba(255,255,255,0.4);
        font-weight: bold;
      }
      
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 10px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .dashboard-card {
        background: #f9fbfd;
        border-radius: 18px;
        padding: 28px 28px 22px 28px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.10);
        border: none;
        position: relative;
        margin-bottom: 8px;
        transition: box-shadow 0.2s, transform 0.2s;
        overflow: visible;
      }
      .dashboard-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 16px;
        bottom: 16px;
        width: 7px;
        border-radius: 8px;
        background: linear-gradient(180deg, #4f8cff 0%, #3ec6e0 100%);
        opacity: 0.85;
      }
      .dashboard-card:hover {
        box-shadow: 0 8px 32px rgba(0,0,0,0.13);
        transform: translateY(-3px) scale(1.012);
      }
      
      .card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 0;
        border-bottom: none;
      }
      .card-icon {
        width: 28px;
        height: 28px;
        margin-right: 0;
        background: #eaf3ff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4f8cff;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 1px 4px #dbeafe;
      }
      .card-title {
        font-size: 1.08em;
        font-weight: 700;
        color: #22334d;
        margin: 0;
        letter-spacing: 0.01em;
      }
      
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }
      
      .status-online {
        background-color: #4CAF50;
      }
      
      .status-warning {
        background-color: #FF9800;
      }
      
      .status-offline {
        background-color: #F44336;
      }
      
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      
      .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0 8px 0;
        padding: 0.4em 0 0.4em 0.2em;
        font-size: 0.98em;
      }
      .metric-label {
        font-weight: 600;
        color: #2a3a4d;
        letter-spacing: 0.01em;
        font-size: 0.97em;
      }
      .metric-value {
        font-weight: 600;
        color: #1a2a3d;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 0.97em;
        background: none;
        border: none;
        padding: 0;
      }
      
      .action-btn {
        flex: 1;
        padding: 5px;
        background: linear-gradient(135deg, #4f8cff 0%, #3ec6e0 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        text-decoration: none;
        text-align: center;
        display: block;
        box-shadow: 0 1px 4px #dbeafe;
      }
      .action-btn:hover {
        transform: translateY(-2px) scale(1.0);
        box-shadow: 0 4px 12px rgba(79,140,255,0.18);
      }
      
      .footer {
        text-align: center;
        margin-top: 30px;
        color: rgba(255,255,255,0.8);
        font-style: italic;
      }
      
      .auto-refresh {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.2);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        border: 1px solid rgba(255,255,255,0.3);
      }
      
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="header">%PROJECT_NAME%</div>
      <div class="version-label">Version %VERSION%</div>
      <div class="tabs">
        <a href="/" class="active">Dashboard</a>
        <!-- Remote tab removed -->
      </div>
      <!-- Antenna Tuner Control button removed -->
      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Network Status Card -->
        <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">📡</div>
          <h3 class="card-title">Network Status</h3>
        </div>
        <div class="metric-item">
          <span class="metric-label">IP Address:</span>
          <span class="metric-value">%IP%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">UDP Discovery:</span>
          <span class="metric-value" style="color: #4CAF50;">Listening on port %UDP_PORT%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">WebSocket Server:</span>
          <span class="metric-value" data-metric="websocket-port">%WEBSOCKET_PORT%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Remote WS:</span>
          <span class="metric-value">
            <span class="status-indicator" id="remote-ws-indicator"></span>
            <span id="remote-ws-label">Unknown</span>
          </span>
        </div>
      </div>

      <!-- System Information Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">⚡</div>
          <h3 class="card-title">System Information</h3>
        </div>
        <div class="metric-item">
          <span class="metric-label">Chip ID:</span>
          <span class="metric-value" data-metric="chip-id">%CHIP_ID%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">CPU Frequency:</span>
          <span class="metric-value" data-metric="cpu-freq">%CPU_FREQ% MHz</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Free Heap:</span>
          <span class="metric-value" data-metric="mem-free">%FREE_HEAP% bytes</span>
        </div>
        <div class="metric-item">
      <!-- Tuner Status card has been removed -->
          <span class="metric-value" data-metric="uptime">%UPTIME%</span>
        </div>
      </div>

      <!-- Memory & Storage Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">💾</div>
          <h3 class="card-title">Memory & Storage</h3>
        </div>
        <div class="metric-item">
          <span class="metric-label">Flash Size:</span>
          <span class="metric-value">%FLASH_TOTAL%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Sketch Size:</span>
          <span class="metric-value">%FLASH_USED%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Free Space:</span>
          <span class="metric-value" data-metric="flash-free">%FLASH_FREE%</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">PSRAM Size:</span>
          <span class="metric-value">%PSRAM_SIZE%</span>
        </div>
      </div>

      <!-- CI-V Information card under Memory & Storage Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon">🛰️</div>
          <h3 class="card-title">CI-V Information</h3>
        </div>
        <div class="metric-item">
          <span class="metric-label">Device Number:</span>
          <input class="metric-value civ-device-input" data-metric="device-number" type="number" min="1" max="4" value="1" />
        </div>
        <!-- Baud Rate removed -->
        <div class="metric-item">
          <span class="metric-label">CI-V Address:</span>
          <span class="metric-value" data-metric="civ-address">0xB8</span>
        </div>
      </div>

      <!-- Tuner Control Card -->
      <div class="dashboard-card">
          <div class="card-header">
            <div class="card-icon">🎚️</div>
            <h3 class="card-title">Tuner Control</h3>
          </div>
          <div class="tuner-indicators-row">
            <div class="tuner-indicator left">
              <span class="indicator-dot tuning"></span>
              <span class="indicator-label">TUNING</span>
            </div>
            <div class="tuner-indicator right">
              <span class="indicator-dot swr"></span>
              <span class="indicator-label">SWR</span>
            </div>
          </div>
          <div class="tuner-grid" style="display:flex; flex-direction:column; align-items:center; width:100%;">
            <!-- Centered row: ANT 1 | AUTO -->
            <div style="display:flex; flex-direction:row; justify-content:center; align-items:center; gap:64px; margin-bottom:32px;">
              <button id="button-ant" class="latch-btn">ANT 1</button>
              <button id="button-auto" class="latch-btn">AUTO</button>
            </div>
            <!-- 3x3 Tuner Control Grid, all buttons and chain links aligned, no lines -->
            <div class="tuner-3x3-grid" style="display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); gap:24px; justify-items:center; align-items:center;">
              <!-- Top row: C-UP | C-UP/L-UP chain | L-UP -->
              <button id="button-cup1" class="momentary-btn" style="grid-row:1; grid-column:1;">C-UP</button>
              <button id="cup-lup-link-btn" aria-label="Toggle C-UP/L-UP Link" style="grid-row:1; grid-column:2; background:none; border:none; padding:0; margin:0; cursor:pointer; display:flex; align-items:center; justify-content:center; width:44px; height:44px;">
                <svg id="cup-lup-link" class="tuner-link-svg" style="width:44px; height:44px; pointer-events:none; display:block;" viewBox="0 0 44 44">
                  <g transform="rotate(45 22 22)">
                    <text x="22" y="27" text-anchor="middle" font-size="28" font-family="Arial" fill="#e53935" alignment-baseline="middle">🔗</text>
                  </g>
                </svg>
              </button>
              <button id="button-lup1" class="momentary-btn" style="grid-row:1; grid-column:3;">L-UP</button>
              <!-- Middle row: C-UP/C-DN chain | TUNE | L-UP/L-DN chain -->
              <button id="cup-cdn-link-btn" aria-label="Toggle C-UP/C-DN Link" style="grid-row:2; grid-column:1; background:none; border:none; padding:0; margin:0; cursor:pointer; display:flex; align-items:center; justify-content:center; width:44px; height:44px;">
                <svg class="tuner-link-svg" style="width:44px; height:44px; pointer-events:none; display:block;" viewBox="0 0 44 44">
                  <g transform="rotate(-45 22 22)">
                    <text x="22" y="27" text-anchor="middle" font-size="28" font-family="Arial" fill="#e53935" alignment-baseline="middle">🔗</text>
                  </g>
                </svg>
              </button>
              <button id="button-tune" class="momentary-btn tune-center" style="grid-row:2; grid-column:2;">TUNE</button>
              <button id="lup-ldn-link-btn" aria-label="Toggle L-UP/L-DN Link" style="grid-row:2; grid-column:3; background:none; border:none; padding:0; margin:0; cursor:pointer; display:flex; align-items:center; justify-content:center; width:44px; height:44px;">
                <svg class="tuner-link-svg" style="width:44px; height:44px; pointer-events:none; display:block;" viewBox="0 0 44 44">
                  <g transform="rotate(-45 22 22)">
                    <text x="22" y="27" text-anchor="middle" font-size="28" font-family="Arial" fill="#e53935" alignment-baseline="middle">🔗</text>
                  </g>
                </svg>
              </button>
              <!-- Bottom row: C-DN | C-DN/L-DN chain | L-DN -->
              <button id="button-cup2" class="momentary-btn" style="grid-row:3; grid-column:1;">C-DN</button>
              <button id="cdn-ldn-link-btn" aria-label="Toggle C-DN/L-DN Link" style="grid-row:3; grid-column:2; background:none; border:none; padding:0; margin:0; cursor:pointer; display:flex; align-items:center; justify-content:center; width:44px; height:44px;">
                <svg class="tuner-link-svg" style="width:44px; height:44px; pointer-events:none; display:block;" viewBox="0 0 44 44">
                  <g transform="rotate(45 22 22)">
                    <text x="22" y="27" text-anchor="middle" font-size="28" font-family="Arial" fill="#e53935" alignment-baseline="middle">🔗</text>
                  </g>
                </svg>
              </button>
              <button id="button-lup2" class="momentary-btn" style="grid-row:3; grid-column:3;">L-DN</button>
            </div>
          </div>
        </div>
      </div>
      </div>


      <div class="footer">
        Dashboard updates in real-time via WebSocket. Last updated: %TIME%
      </div>
    </div>

    <script>
      // --- Chain Link Interactivity for C-UP/L-UP ---
      let cupLupLinked = false;
        function setCupLupLinkColor(blue) {
          // Optionally update the dashed line color if you want to visually indicate the link state on the main line
          const mainLine = document.getElementById('cup-lup-link-line');
          if (mainLine) {
            mainLine.setAttribute('stroke', blue ? '#2196f3' : '#ccc');
          }
        }
      document.addEventListener('DOMContentLoaded', function() {
        // --- Chain Link Button Toggle Logic ---
        const chainLinks = [
          { id: 'cup-lup-link-btn', state: false },
          { id: 'cup-cdn-link-btn', state: false },
          { id: 'lup-ldn-link-btn', state: false },
          { id: 'cdn-ldn-link-btn', state: false }
        ];
        // Map chain buttons to their affected tuner buttons
        const chainMap = {
          'cup-lup-link-btn': ['button-cup1', 'button-lup1'], // Top row
          'cup-cdn-link-btn': ['button-cup1', 'button-cup2'], // Left column (C-UP, C-DN)
          'lup-ldn-link-btn': ['button-lup1', 'button-lup2'], // Right column (L-UP, L-DN)
          'cdn-ldn-link-btn': ['button-cup2', 'button-lup2']  // Bottom row
        };
        chainLinks.forEach(link => {
          const btn = document.getElementById(link.id);
          if (!btn) return;
          btn.classList.add('chain-link-btn');
          btn.addEventListener('click', function(e) {
            if (link.state) {
              // If already active, deactivate this chain button and its highlights
              link.state = false;
              btn.classList.remove('active');
              (chainMap[link.id] || []).forEach(id => {
                const b = document.getElementById(id);
                if (b) b.classList.remove('chain-highlight');
              });
            } else {
              // Deactivate all other chain buttons and highlights
              chainLinks.forEach(otherLink => {
                const otherBtn = document.getElementById(otherLink.id);
                otherLink.state = false;
                if (otherBtn) otherBtn.classList.remove('active');
                (chainMap[otherLink.id] || []).forEach(id => {
                  const b = document.getElementById(id);
                  if (b) b.classList.remove('chain-highlight');
                });
              });
              // Activate this chain button and its highlights
              link.state = true;
              btn.classList.add('active');
              (chainMap[link.id] || []).forEach(id => {
                const b = document.getElementById(id);
                if (b) b.classList.add('chain-highlight');
              });
            }
            e.preventDefault();
            e.stopPropagation();
          });
        });
        // --- Link logic for all chain buttons and their mapped tuner buttons ---
        const chainLinkLogic = [
          { chainId: 'cup-lup-link-btn', btns: ['button-cup1', 'button-lup1'] },
          { chainId: 'cup-cdn-link-btn', btns: ['button-cup1', 'button-cup2'] },
          { chainId: 'lup-ldn-link-btn', btns: ['button-lup1', 'button-lup2'] },
          { chainId: 'cdn-ldn-link-btn', btns: ['button-cup2', 'button-lup2'] }
        ];
        chainLinkLogic.forEach(link => {
          const chainBtn = document.getElementById(link.chainId);
          const btnA = document.getElementById(link.btns[0]);
          const btnB = document.getElementById(link.btns[1]);
          if (!chainBtn || !btnA || !btnB) return;
          // Track last sent state for each button to suppress duplicate sends
          let lastSentState = { [btnA.id]: null, [btnB.id]: null };
          function setLinkedActive(active) {
            btnA.classList.toggle('active', active);
            btnB.classList.toggle('active', active);
            if (active) {
              btnA.classList.add('linked-pressed');
              btnB.classList.add('linked-pressed');
            } else {
              btnA.classList.remove('linked-pressed');
              btnB.classList.remove('linked-pressed');
            }
          }
          function sendMomentary(id, state) {
            if (lastSentState[id] !== state) {
              lastSentState[id] = state;
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(`momentary:${id}:${state}`);
              }
            }
          }
          function handleLinkedDown(e) {
            const linked = chainBtn.classList.contains('active');
            if (linked) {
              setLinkedActive(true);
              btnA.classList.add('active');
              btnB.classList.add('active');
              // Send only one message for the event (one-shot, no duplicates)
              if (e.target === btnA) {
                sendMomentary(btnA.id, 'on');
              } else if (e.target === btnB) {
                sendMomentary(btnB.id, 'on');
              }
            } else {
              if (e.target === btnA) {
                btnA.classList.add('active');
                sendMomentary(btnA.id, 'on');
              } else if (e.target === btnB) {
                btnB.classList.add('active');
                sendMomentary(btnB.id, 'on');
              }
            }
          }
          function handleLinkedUp(e) {
            const linked = chainBtn.classList.contains('active');
            if (linked) {
              setLinkedActive(false);
              btnA.classList.remove('active');
              btnB.classList.remove('active');
              // Send only one message for the event (one-shot, no duplicates)
              if (e.target === btnA) {
                sendMomentary(btnA.id, 'off');
              } else if (e.target === btnB) {
                sendMomentary(btnB.id, 'off');
              }
            } else {
              if (e.target === btnA) {
                btnA.classList.remove('active');
                sendMomentary(btnA.id, 'off');
              } else if (e.target === btnB) {
                btnB.classList.remove('active');
                sendMomentary(btnB.id, 'off');
              }
            }
          }
          [btnA, btnB].forEach(btn => {
            btn.addEventListener('mousedown', handleLinkedDown);
            btn.addEventListener('touchstart', handleLinkedDown);
            btn.addEventListener('mouseup', handleLinkedUp);
            btn.addEventListener('mouseleave', handleLinkedUp);
            btn.addEventListener('touchend', handleLinkedUp);
          });
        });
      });
      // WebSocket connection for real-time updates
      let ws = null;
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5;
      const reconnectDelay = 3000; // 3 seconds

      function connectWebSocket() {
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/dashboard-ws`;
          
          ws = new WebSocket(wsUrl);
          
          ws.onopen = function() {
            console.log('Dashboard WebSocket connected');
            reconnectAttempts = 0;
            // Request initial update
            ws.send('request_update');
          };
          
          ws.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              if (data.type === 'dashboard_update') {
                updateDashboard(data);
              }
            } catch (e) {
              console.error('Error parsing WebSocket message:', e);
            }
          };
          
          ws.onclose = function() {
            console.log('Dashboard WebSocket disconnected');
            ws = null;
            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
              reconnectAttempts++;
              setTimeout(connectWebSocket, reconnectDelay);
            }
          };
          
          ws.onerror = function(error) {
            console.error('Dashboard WebSocket error:', error);
          };
        } catch (e) {
          console.error('Error creating WebSocket connection:', e);
        }
      }

      function updateDashboard(data) {
        // --- Tuner Control Card: Update latch button states and labels ---
        // ANT button
        const antBtn = document.getElementById('button-ant');
        if (antBtn) {
          const isAnt2 = (data.ant_state && data.ant_state.trim() === 'ANT 2');
          antBtn.classList.toggle('active', isAnt2);
          antBtn.textContent = isAnt2 ? 'ANT 2' : 'ANT 1';
        }
        // AUTO button
        const autoBtn = document.getElementById('button-auto');
        if (autoBtn) {
          const isAuto = (data.auto_state && data.auto_state.trim() === 'AUTO');
          autoBtn.classList.toggle('active', isAuto);
          autoBtn.textContent = isAuto ? 'AUTO' : 'SEMI';
        }
        // Do NOT reset momentary button states for C-UP, L-UP, C-DN, L-DN, TUNE on WS update
        // Their state is now managed only by user interaction
        // --- Optionally update TUNING/SWR indicators if backend provides fields ---
        // Example: data.tuning_active, data.swr_ok (add to JSON if needed)
        // const tuningDot = document.querySelector('.indicator-dot.tuning');
        // if (tuningDot && typeof data.tuning_active !== 'undefined') {
        //   tuningDot.style.background = data.tuning_active ? '#e53935' : '#bbb';
        // }
        // const swrDot = document.querySelector('.indicator-dot.swr');
        // if (swrDot && typeof data.swr_ok !== 'undefined') {
        //   swrDot.style.background = data.swr_ok ? '#388e3c' : '#bbb';
        // }
        // Update time display
        updateElementIfExists('#current-time', data.time || 'TIME_NOT_SET');
        
        // Update system metrics
        updateElementIfExists('[data-metric="mem-total"]', `${data.mem_total || 0} KB`);
        updateElementIfExists('[data-metric="mem-used"]', `${data.mem_used || 0} KB`);
        updateElementIfExists('[data-metric="mem-free"]', `${data.mem_free || 0} KB`);
        updateElementIfExists('[data-metric="flash-total"]', `${data.flash_total || 0} KB`);
        updateElementIfExists('[data-metric="flash-used"]', `${data.flash_used || 0} KB`);
        updateElementIfExists('[data-metric="flash-free"]', `${data.flash_free || 0} KB`);
        updateElementIfExists('[data-metric="uptime"]', data.uptime || 'Unknown');
        updateElementIfExists('[data-metric="chip-id"]', data.chip_id || 'Unknown');
        updateElementIfExists('[data-metric="chip-rev"]', data.chip_rev || 'Unknown');
        updateElementIfExists('[data-metric="cpu-freq"]', `${data.cpu_freq || 0} MHz`);
        updateElementIfExists('[data-metric="psram-size"]', `${data.psram_size || 0} KB`);
        
        // Update antenna states
        updateElementIfExists('[data-metric="ant-state"]', data.ant_state || 'Unknown');
        updateElementIfExists('[data-metric="auto-state"]', data.auto_state || 'Unknown');

        // Update CI-V card fields
        updateElementIfExists('[data-metric="civ-baud"]', '19200');
        const devNumInput = document.querySelector('[data-metric="device-number"]');
        let devNum = 1;
        if (data.device_number) {
          devNum = parseInt(data.device_number);
        } else if (devNumInput && devNumInput.value) {
          devNum = parseInt(devNumInput.value);
        }
        if (isNaN(devNum) || devNum < 1) devNum = 1;
        if (devNum > 4) devNum = 4;
        if (devNumInput) devNumInput.value = devNum;
        // Calculate CI-V Address based on device number (1-4)
        let civHex = (0xB7 + devNum).toString(16).toUpperCase();
        if (civHex.length < 2) civHex = '0' + civHex;
        let civDisplay = '0x' + civHex;
        updateElementIfExists('[data-metric="civ-address"]', civDisplay);

// Remove duplicate DOMContentLoaded above.

        // Update connection info
        updateElementIfExists('[data-metric="ip-address"]', data.ip || 'Unknown');
        // Show full IP:PORT for WebSocket Server
        let wsServerDisplay = data.websocket_port || 'Unknown';
        if (/^\d+$/.test(wsServerDisplay) && data.ip) {
          wsServerDisplay = data.ip + ':' + wsServerDisplay;
        }
        updateElementIfExists('[data-metric="websocket-port"]', wsServerDisplay);
        updateElementIfExists('[data-metric="udp-port"]', data.udp_port || 'Unknown');


        // Update Remote WS connection status indicator and label
        const remoteWsIndicator = document.getElementById('remote-ws-indicator');
        const remoteWsLabel = document.getElementById('remote-ws-label');
        if (typeof data.remote_ws_connected !== 'undefined') {
          if (remoteWsIndicator) remoteWsIndicator.className = 'status-indicator ' + (data.remote_ws_connected ? 'status-online' : 'status-offline');
          if (remoteWsLabel) {
            remoteWsLabel.textContent = data.remote_ws_connected ? 'Connected' : 'Disconnected';
            remoteWsLabel.style.color = data.remote_ws_connected ? '#4CAF50' : '#F44336';
          }
        } else {
          if (remoteWsIndicator) remoteWsIndicator.className = 'status-indicator status-offline';
          if (remoteWsLabel) {
            remoteWsLabel.textContent = 'Unknown';
            remoteWsLabel.style.color = '#888';
          }
        }

        // Update last update time
        const now = new Date().toLocaleTimeString();
        updateElementIfExists('.footer', `Dashboard updates in real-time via WebSocket. Last updated: ${now}`);

        // Update status indicators based on system state
        updateSystemStatus(data);
      }

      function updateElementIfExists(selector, value) {
        const element = document.querySelector(selector);
        if (element) {
          element.textContent = value;
        }
      }

      function updateSystemStatus(data) {
        // Update status indicators based on OTA, captive portal, etc.
        const statusElements = document.querySelectorAll('.status-indicator');
        statusElements.forEach(indicator => {
          if (data.ota_active) {
            indicator.className = 'status-indicator status-warning';
          } else if (data.captive_portal_active) {
            indicator.className = 'status-indicator status-offline';
          } else {
            indicator.className = 'status-indicator status-online';
          }
        });
      }

      // Initialize WebSocket connection when page loads
      document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        const devNumInput = document.querySelector('[data-metric="device-number"]');
        if (devNumInput) {
          let lastSentDeviceNumber = parseInt(devNumInput.value);
          devNumInput.addEventListener('change', function() {
            let devNum = parseInt(devNumInput.value);
            if (isNaN(devNum) || devNum < 1) devNum = 1;
            if (devNum > 4) devNum = 4;
            devNumInput.value = devNum;
            if (ws && ws.readyState === WebSocket.OPEN && devNum !== lastSentDeviceNumber) {
              ws.send(JSON.stringify({ set_device_number: devNum }));
              lastSentDeviceNumber = devNum;
              console.log('Sent set_device_number:', devNum);
            }
            // Do NOT update CI-V address here; wait for server broadcast
          });
        }
        // Add interactivity to cards
        document.querySelectorAll('.dashboard-card').forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.02)';
          });
          card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
          });
        });
        // --- Tuner Control Button Logic ---
        // Latch buttons: ANT 1, AUTO
        const latchButtons = [
          { id: 'button-ant', stateKey: 'ant_state', onLabel: 'ANT 2', offLabel: 'ANT 1' },
          { id: 'button-auto', stateKey: 'auto_state', onLabel: 'AUTO', offLabel: 'SEMI' }
        ];
        latchButtons.forEach(btn => {
          const el = document.getElementById(btn.id);
          if (!el) return;
          el.addEventListener('click', function() {
            // Determine current state from label (not from .active, which may be stale)
            const isCurrentlyOn = el.textContent.trim() === btn.onLabel;
            const newState = !isCurrentlyOn;
            // Send latch command to server
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(`latch:${btn.id}:${newState}`);
            }
            // Optimistically update UI (will be corrected by updateDashboard on server reply)
            el.classList.toggle('active', newState);
            el.textContent = newState ? btn.onLabel : btn.offLabel;
          });
        });

        // Momentary buttons: C-DN, L-DN only (C-UP and L-UP handled by custom logic above)
        const momentaryButtons = [
          'button-cdn', 'button-ldn'
        ];
        momentaryButtons.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('mousedown', function() {
            el.classList.add('active');
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(`momentary:${id}:on`);
            }
          });
          el.addEventListener('mouseup', function() {
            el.classList.remove('active');
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(`momentary:${id}:off`);
            }
          });
          el.addEventListener('mouseleave', function() {
            el.classList.remove('active');
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(`momentary:${id}:off`);
            }
          });
          el.addEventListener('touchstart', function(e) {
            e.preventDefault();
            el.classList.add('active');
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(`momentary:${id}:on`);
            }
          }, { passive: false });
          el.addEventListener('touchend', function(e) {
            e.preventDefault();
            el.classList.remove('active');
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(`momentary:${id}:off`);
            }
          }, { passive: false });
        });

        // Add interactivity to cards
        document.querySelectorAll('.dashboard-card').forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.02)';
          });
          card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
          });
        });
      // End of DOMContentLoaded
    });

      // Cleanup WebSocket when page unloads
      window.addEventListener('beforeunload', function() {
        if (ws) {
          ws.close();
        }
      });
    </script>
  </body>
</html>
